<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Anaphygon CDN Interface</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      line-height: 1.6;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      background-color: #f5f5f5;
    }
    .navbar {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
      padding: 15px;
      border-radius: 8px;
      background-color: white;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .navbar a {
      text-decoration: none;
      color: #333;
      font-weight: bold;
      padding: 8px 12px;
      border-radius: 4px;
      transition: all 0.3s ease;
    }
    .navbar a:hover {
      color: #007bff;
      background-color: #f0f0f0;
    }
    .navbar a.active {
      background-color: #007bff;
      color: white;
    }
    .container {
      background-color: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      margin-top: 20px;
    }
    .hidden {
      display: none;
    }
    button {
      background: #007bff;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    button:hover {
      background: #0056b3;
    }
    button:disabled {
      background: #cccccc;
      cursor: not-allowed;
    }
    input, select {
      padding: 10px;
      margin-bottom: 15px;
      border: 1px solid #ddd;
      border-radius: 4px;
      width: 100%;
      box-sizing: border-box;
    }
    input:focus {
      border-color: #007bff;
      outline: none;
      box-shadow: 0 0 0 2px rgba(0,123,255,0.25);
    }
    .file-card {
      border: 1px solid #eee;
      padding: 20px;
      margin-bottom: 15px;
      border-radius: 8px;
      transition: transform 0.2s ease;
    }
    .file-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .file-card img {
      max-width: 150px;
      max-height: 150px;
      margin-right: 15px;
      border-radius: 4px;
    }
    .file-actions {
      margin-top: 15px;
      display: flex;
      gap: 10px;
    }
    #statusMessage {
      padding: 15px;
      margin: 15px 0;
      border-radius: 4px;
      transition: all 0.3s ease;
    }
    .success {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .error {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .user-info {
      background-color: #e9ecef;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .badge {
      display: inline-block;
      font-size: 12px;
      font-weight: bold;
      padding: 5px 10px;
      border-radius: 20px;
      margin-right: 5px;
      background-color: #6c757d;
      color: white;
    }
    .badge.admin {
      background-color: #dc3545;
    }
    .badge.user {
      background-color: #28a745;
    }
    .form-group {
      margin-bottom: 20px;
    }
    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: bold;
      color: #333;
    }
    .loading {
      position: relative;
      pointer-events: none;
    }
    .loading::after {
      content: "";
      position: absolute;
      width: 20px;
      height: 20px;
      top: 50%;
      left: 50%;
      margin: -10px 0 0 -10px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #007bff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .admin-card {
      background-color: #f8f9fa;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    .info-card {
      background-color: white;
      border-radius: 8px;
      padding: 15px;
      margin-top: 15px;
      border: 1px solid #eee;
    }
    .info-card h4 {
      margin-top: 15px;
      margin-bottom: 10px;
      color: #007bff;
      border-bottom: 1px solid #eee;
      padding-bottom: 5px;
    }
    .info-card ul {
      padding-left: 20px;
    }
    #system-info {
      margin-top: 15px;
    }
    .users-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    
    .user-card {
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      padding: 15px;
      transition: transform 0.2s ease;
    }
    
    .user-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    
    .user-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      border-bottom: 1px solid #eee;
      padding-bottom: 10px;
    }
    
    .user-header h3 {
      margin: 0;
      color: #333;
    }
    
    .user-details {
      font-size: 14px;
    }
    
    .user-details p {
      margin: 5px 0;
    }
    
    .user-actions {
      margin-top: 15px;
      display: flex;
      justify-content: flex-end;
    }
    
    .active-badge {
      background-color: #28a745;
      color: white;
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 12px;
    }
    
    .inactive-badge {
      background-color: #dc3545;
      color: white;
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 12px;
    }
    
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    
    .modal-content {
      background-color: white;
      padding: 20px;
      border-radius: 8px;
      width: 80%;
      max-width: 800px;
      max-height: 80vh;
      overflow-y: auto;
      position: relative;
    }
    
    .close-button {
      position: absolute;
      top: 10px;
      right: 15px;
      font-size: 24px;
      cursor: pointer;
      color: #777;
    }
    
    .close-button:hover {
      color: #333;
    }
    
    .files-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }
    
    .file-item {
      background-color: #f9f9f9;
      border-radius: 8px;
      padding: 10px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    
    .file-item img {
      max-width: 100%;
      height: auto;
      border-radius: 4px;
      margin-bottom: 10px;
    }
    
    .file-details {
      font-size: 12px;
      width: 100%;
    }
    
    .file-details p {
      margin: 3px 0;
    }
    
    .user-stats {
      background-color: #f5f5f5;
      padding: 10px 15px;
      border-radius: 8px;
      margin: 10px 0 20px 0;
      display: flex;
      justify-content: space-between;
    }
  </style>
</head>
<body>
<h1>Anaphygon CDN Interface</h1>

<div class="navbar hidden" id="main-nav">
  <a href="#" onclick="showSection('upload-section')" id="nav-upload">Upload File</a>
  <a href="#" onclick="showSection('files-section')" id="nav-files">View Files</a>
  <a href="#" onclick="showSection('users-section')" id="nav-users" class="hidden">Manage Users</a>
  <a href="#" onclick="showSection('admin-section')" id="nav-admin" class="hidden">Admin Panel</a>
  <a href="#" id="logout-link" onclick="logout()">Logout</a>
</div>

<div class="navbar" id="auth-nav">
  <a href="#" onclick="showSection('login-section')" id="nav-login" class="active">Login</a>
  <a href="#" onclick="showSection('register-section')" id="nav-register">Register</a>
</div>

<div id="statusMessage" class="hidden"></div>

<div id="user-info" class="user-info hidden">
  <div>
    <h3>Welcome, <span id="username-display"></span></h3>
    <div>Roles: <span id="roles-display"></span></div>
  </div>
  <div id="admin-badge" class="hidden">
    <span class="badge admin">ADMIN</span>
  </div>
</div>

<div id="login-section" class="container">
  <h2>Login</h2>
  <form id="login-form" onsubmit="handleLogin(event)">
    <div class="form-group">
      <label for="login-username">Username or Email:</label>
      <input type="text" id="login-username" placeholder="Enter username or email" required>
    </div>
    <div class="form-group">
      <label for="login-password">Password:</label>
      <input type="password" id="login-password" placeholder="Enter password" required>
    </div>
    <button type="submit" id="login-button">Login</button>
  </form>
</div>

<div id="register-section" class="container hidden">
  <h2>Register</h2>
  <form id="register-form" onsubmit="handleRegister(event)">
    <div class="form-group">
      <label for="register-username">Username:</label>
      <input type="text" id="register-username" placeholder="Choose a username" required>
    </div>
    <div class="form-group">
      <label for="register-email">Email:</label>
      <input type="email" id="register-email" placeholder="Enter your email address" required>
    </div>
    <div class="form-group">
      <label for="register-password">Password:</label>
      <input type="password" id="register-password" placeholder="Choose a password" required>
    </div>
    <button type="submit" id="register-button">Register</button>
  </form>
</div>

<div id="upload-section" class="container hidden">
  <h2>Upload File</h2>
  <form id="upload-form" onsubmit="handleUpload(event)">
    <div class="form-group">
      <label for="file-input">Select File:</label>
      <input type="file" id="file-input" required>
    </div>
    <button type="submit" id="upload-button">Upload</button>
  </form>
</div>

<div id="files-section" class="container hidden">
  <h2>Your Files</h2>
  <button onclick="loadFiles()" id="refresh-button">Refresh Files</button>
  <div id="files-list">
    <p>Click "Refresh Files" to load your files...</p>
  </div>
</div>

<div id="admin-section" class="container hidden">
  <h2>Admin Panel</h2>
  <div class="admin-card">
    <h3>System Information</h3>
    <p>You're logged in as an administrator with full access to the system.</p>
    <button onclick="loadSystemInfo()" id="system-info-button">Load System Info</button>
    <div id="system-info"></div>
  </div>
</div>

<div id="users-section" class="container hidden">
  <h2>User Management</h2>
  <button onclick="loadUsers()" id="load-users-button">Load Users</button>
  <div id="users-list" class="users-container">
    <p>Click "Load Users" to see all registered users.</p>
  </div>
</div>

<script>
  // Global variables
  let token = localStorage.getItem('cdnToken');
  let csrfToken = '';
  let currentUser = JSON.parse(localStorage.getItem('cdnUser')) || null;

  // Initialize the application state
  function initializeApp() {
    if (token && currentUser) {
      document.getElementById('auth-nav').classList.add('hidden');
      document.getElementById('main-nav').classList.remove('hidden');
      document.getElementById('user-info').classList.remove('hidden');
      document.getElementById('username-display').textContent = currentUser.username;
      
      // Ensure roles is an array
      if (!currentUser.roles) {
        currentUser.roles = [];
      } else if (typeof currentUser.roles === 'string') {
        currentUser.roles = [currentUser.roles];
      } else if (typeof currentUser.roles === 'object' && !Array.isArray(currentUser.roles)) {
        // Handle case when roles is an object (from JSON)
        currentUser.roles = Object.values(currentUser.roles);
      }
      
      console.log("Current user:", currentUser);
      displayRoles(currentUser.roles);
      
      // Check for admin privileges - safer check for ADMIN role
      const hasAdminRole = Array.isArray(currentUser.roles) && 
                          currentUser.roles.some(role => role === 'ADMIN');
      
      // Show admin sections if user has admin role
      const adminNav = document.getElementById('nav-admin');
      const usersNav = document.getElementById('nav-users');
      
      if (hasAdminRole) {
        adminNav.classList.remove('hidden');
        usersNav.classList.remove('hidden');
        console.log("Admin navigation enabled");
      } else {
        adminNav.classList.add('hidden');
        usersNav.classList.add('hidden');
      }
      
      showSection('files-section');
    } else {
      document.getElementById('auth-nav').classList.remove('hidden');
      document.getElementById('main-nav').classList.add('hidden');
      document.getElementById('user-info').classList.add('hidden');
      showSection('login-section');
    }
  }

  // Display user roles with badges
  function displayRoles(roles) {
    const rolesDisplay = document.getElementById('roles-display');
    rolesDisplay.innerHTML = '';
    
    const adminBadge = document.getElementById('admin-badge');
    adminBadge.classList.add('hidden');

    if (!roles || roles.length === 0) {
      rolesDisplay.textContent = 'None';
      return;
    }

    // Ensure roles is an array
    let rolesArray = roles;
    if (!Array.isArray(roles)) {
      if (typeof roles === 'string') {
        rolesArray = [roles];
      } else if (typeof roles === 'object') {
        rolesArray = Object.values(roles);
      } else {
        rolesArray = [];
      }
    }
    
    // Log roles for debugging
    console.log("User roles array:", rolesArray);

    rolesArray.forEach(role => {
      if (!role) return; // Skip null/undefined roles
      
      const badge = document.createElement('span');
      badge.className = `badge ${role.toLowerCase()}`;
      badge.textContent = role;
      rolesDisplay.appendChild(badge);
      
      // Show admin badge for admin users
      if (role === 'ADMIN') {
        adminBadge.classList.remove('hidden');
        console.log("Admin role detected");
      }
    });
  }

  // Fetch CSRF token
  async function getCsrfToken() {
    try {
      const response = await fetch('http://localhost:8080/api/auth/csrf', {
        method: 'GET',
        credentials: 'include'
      });
      
      if (!response.ok) {
        throw new Error('Failed to fetch CSRF token');
      }

      const cookies = document.cookie.split(';');
      for (let cookie of cookies) {
        const [name, value] = cookie.trim().split('=');
        if (name === 'XSRF-TOKEN') {
          csrfToken = value;
          return value;
        }
      }
      return null;
    } catch (error) {
      console.error('Error fetching CSRF token:', error);
      showMessage('Failed to fetch CSRF token: ' + error.message, true);
      return null;
    }
  }

  // Show message to user
  function showMessage(message, isError = false) {
    const statusElement = document.getElementById('statusMessage');
    statusElement.textContent = message;
    statusElement.classList.remove('hidden', 'success', 'error');
    statusElement.classList.add(isError ? 'error' : 'success');

    // Hide after 5 seconds
    setTimeout(() => {
      statusElement.classList.add('hidden');
    }, 5000);
  }

  // Show section and update navigation
  function showSection(sectionId) {
    // Hide all sections
    document.querySelectorAll('.container').forEach(section => {
      section.classList.add('hidden');
    });

    // Show selected section
    document.getElementById(sectionId).classList.remove('hidden');

    // Update navigation active states
    document.querySelectorAll('.navbar a').forEach(link => {
      link.classList.remove('active');
    });

    // Set active nav item
    const navId = 'nav-' + sectionId.replace('-section', '');
    const navItem = document.getElementById(navId);
    if (navItem) {
      navItem.classList.add('active');
    }

    // Load files if showing files section
    if (sectionId === 'files-section' && token) {
      loadFiles();
    }
  }

  // Handle API responses
  async function handleResponse(response) {
    const contentType = response.headers.get("content-type");
    if (contentType && contentType.indexOf("application/json") !== -1) {
      const data = await response.json();
      if (!response.ok) {
        throw new Error(data.error || data.message || 'An error occurred');
      }
      return data;
    } else {
      const text = await response.text();
      if (!response.ok) {
        throw new Error(text || 'An error occurred');
      }
      return text;
    }
  }

  // Handle login
  async function handleLogin(e) {
    e.preventDefault();
    const button = document.getElementById('login-button');
    button.disabled = true;
    button.classList.add('loading');

    try {
      const usernameOrEmail = document.getElementById('login-username').value;
      const password = document.getElementById('login-password').value;

      const response = await fetch('http://localhost:8080/api/auth/login', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ usernameOrEmail, password }),
        credentials: 'include'
      });

      const data = await handleResponse(response);
      
      // Log the full response for debugging
      console.log("Full login response:", data);

      if (data.success) {
        token = data.data.token;
        
        // Extract roles properly from JSON response
        let roles = [];
        if (data.data.roles) {
          if (Array.isArray(data.data.roles)) {
            roles = data.data.roles;
          } else if (typeof data.data.roles === 'string') {
            roles = [data.data.roles];
          } else if (typeof data.data.roles === 'object') {
            // Extract values from object if roles is a JSON object with indices as keys
            roles = Object.values(data.data.roles);
          }
        }
        
        console.log("Parsed roles:", roles);
        
        currentUser = {
          id: data.data.userId,
          username: data.data.username,
          roles: roles
        };

        localStorage.setItem('cdnToken', token);
        localStorage.setItem('cdnUser', JSON.stringify(currentUser));

        showMessage('Logged in successfully!');
        initializeApp();
      } else {
        throw new Error(data.error || 'Login failed');
      }
    } catch (error) {
      showMessage(error.message, true);
    } finally {
      button.disabled = false;
      button.classList.remove('loading');
    }
  }

  // Handle register
  async function handleRegister(e) {
    e.preventDefault();
    const button = document.getElementById('register-button');
    button.disabled = true;
    button.classList.add('loading');

    try {
      const username = document.getElementById('register-username').value;
      const email = document.getElementById('register-email').value;
      const password = document.getElementById('register-password').value;

      const response = await fetch('http://localhost:8080/api/auth/register', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ username, email, password }),
        credentials: 'include'
      });

      const data = await handleResponse(response);
      
      // Log the full response for debugging
      console.log("Full register response:", data);

      if (data.success) {
        token = data.data.token;
        
        // Extract roles properly from JSON response
        let roles = [];
        if (data.data.roles) {
          if (Array.isArray(data.data.roles)) {
            roles = data.data.roles;
          } else if (typeof data.data.roles === 'string') {
            roles = [data.data.roles];
          } else if (typeof data.data.roles === 'object') {
            // Extract values from object if roles is a JSON object with indices as keys
            roles = Object.values(data.data.roles);
          }
        }
        
        console.log("Parsed roles:", roles);
        
        currentUser = {
          id: data.data.userId,
          username: data.data.username,
          roles: roles
        };

        localStorage.setItem('cdnToken', token);
        localStorage.setItem('cdnUser', JSON.stringify(currentUser));

        showMessage('Registered successfully!');
        initializeApp();
      } else {
        throw new Error(data.error || 'Registration failed');
      }
    } catch (error) {
      showMessage(error.message, true);
    } finally {
      button.disabled = false;
      button.classList.remove('loading');
    }
  }

  // Handle file upload
  async function handleUpload(e) {
    e.preventDefault();
    const button = document.getElementById('upload-button');
    button.disabled = true;
    button.classList.add('loading');

    try {
      if (!token) {
        throw new Error('Please login first!');
      }

      const fileInput = document.getElementById('file-input');
      if (!fileInput.files[0]) {
        throw new Error('Please select a file!');
      }

      // Get CSRF token if not already present
      if (!csrfToken) {
        await getCsrfToken();
      }

      const formData = new FormData();
      formData.append('file', fileInput.files[0]);

      const response = await fetch('http://localhost:8080/api/files', {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${token}`,
          'X-XSRF-TOKEN': csrfToken
        },
        body: formData,
        credentials: 'include'
      });

      const data = await handleResponse(response);

      if (data.success) {
        showMessage('File uploaded successfully!');
        fileInput.value = '';
        showSection('files-section');
      } else {
        throw new Error(data.error || 'Upload failed');
      }
    } catch (error) {
      showMessage(error.message, true);
    } finally {
      button.disabled = false;
      button.classList.remove('loading');
    }
  }

  // Load files
  async function loadFiles() {
    const button = document.getElementById('refresh-button');
    button.disabled = true;
    button.classList.add('loading');

    try {
      if (!token) {
        throw new Error('Please login first!');
      }

      // First try the standard API endpoint
      try {
        const response = await fetch('http://localhost:8080/api/files', {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        console.log("Standard API response status:", response.status);
        
        if (response.ok) {
          const responseText = await response.text();
          console.log("Raw files response (standard endpoint):", responseText);
          
          try {
            const data = JSON.parse(responseText);
            console.log("Parsed files data (standard endpoint):", data);

            if (data.success && Array.isArray(data.data)) {
              console.log("Files data to display (standard endpoint):", data.data);
              displayFiles(data.data);
              button.disabled = false;
              button.classList.remove('loading');
              return;
            }
          } catch (parseError) {
            console.error("Error parsing JSON:", parseError);
          }
        }
      } catch (error) {
        console.error("Error with standard endpoint, trying fallback:", error);
      }

      // If that fails, try the db-status endpoint
      const response = await fetch('http://localhost:8080/api/files/db-status', {
        method: 'GET',
        headers: {
          'Authorization': `Bearer ${token}`
        }
      });

      const responseText = await response.text();
      console.log("Raw files response (db-status):", responseText);
      
      try {
        const data = JSON.parse(responseText);
        console.log("Parsed files data (db-status):", data);

        if (data.success) {
          let filesToDisplay = null;
          
          // Check for files array in the proper location in the new response structure
          if (data.data && Array.isArray(data.data.files)) {
            filesToDisplay = data.data.files;
          } else if (data.data && data.data.files) {
            filesToDisplay = data.data.files;
          } else if (Array.isArray(data.data)) {
            filesToDisplay = data.data;
          } else {
            filesToDisplay = [];
          }
          
          console.log("Files to display (db-status):", filesToDisplay);
          displayFiles(filesToDisplay);
        } else {
          throw new Error(data.error || 'Failed to load files');
        }
      } catch (parseError) {
        console.error("Error parsing response:", parseError);
        showMessage("Error loading files: Invalid response from server", true);
      }
    } catch (error) {
      console.error("Error loading files:", error);
      showMessage(error.message, true);
    } finally {
      button.disabled = false;
      button.classList.remove('loading');
    }
  }

  // Display files
  function displayFiles(files) {
    console.log("displayFiles received:", files);
    console.log("Type of files:", typeof files);
    console.log("Is Array:", Array.isArray(files));
    
    const filesList = document.getElementById('files-list');

    // If no files or empty array
    if (!files || (Array.isArray(files) && files.length === 0)) {
      console.log("No files found or empty array");
      filesList.innerHTML = '<p>No files found.</p>';
      return;
    }

    // Ensure files is an array
    let filesArray = files;
    if (!Array.isArray(files)) {
      if (typeof files === 'object') {
        console.log("Converting object to array:", files);
        filesArray = Object.values(files);
        console.log("After conversion:", filesArray);
      } else if (typeof files === 'string') {
        try {
          // Try to parse if it's a JSON string
          const parsed = JSON.parse(files);
          filesArray = Array.isArray(parsed) ? parsed : Object.values(parsed);
          console.log("Parsed from string:", filesArray);
        } catch (e) {
          console.log("Not a valid JSON string:", files);
          filesList.innerHTML = '<p>Error parsing file data.</p>';
          return;
        }
      } else {
        console.log("Not a recognized format:", files);
        filesList.innerHTML = '<p>No files found.</p>';
        return;
      }
    }

    // Check if the array is empty
    if (filesArray.length === 0) {
      console.log("Empty array of files");
      filesList.innerHTML = '<p>No files found.</p>';
      return;
    }

    console.log("Processing files array with length:", filesArray.length);
    
    let html = '';
    filesArray.forEach(file => {
      console.log("Processing file:", file);
      // Ensure file has all required properties
      if (!file || !file.id || !file.fileName) {
        console.log("Skipping invalid file object:", file);
        return;
      }
      
      const isImage = file.contentType && file.contentType.startsWith('image/');
      html += `
        <div class="file-card">
          <div>
            ${isImage ? `<img src="http://localhost:8080/api/files/${file.id}" alt="${file.fileName}">` : ''}
            <strong>${file.fileName}</strong>
          </div>
          <div>ID: ${file.id}</div>
          <div>Type: ${file.contentType || 'Unknown'}</div>
          <div>Size: ${formatFileSize(file.size || 0)}</div>
          <div>Uploaded: ${formatDate(file.uploadDate || Date.now())}</div>
          <div class="file-actions">
            <button onclick="window.open('http://localhost:8080/api/files/${file.id}', '_blank')">Download</button>
            ${isImage ? `
              <button onclick="window.open('http://localhost:8080/api/files/${file.id}/thumbnail', '_blank')">Thumbnail</button>
              <button onclick="window.open('http://localhost:8080/api/files/${file.id}/resize?width=300&height=200', '_blank')">Resize</button>
            ` : ''}
            <button onclick="deleteFile('${file.id}')" style="background-color: #dc3545;">Delete</button>
          </div>
        </div>
      `;
    });
    
    if (html === '') {
      filesList.innerHTML = '<p>No valid files found to display.</p>';
    } else {
      filesList.innerHTML = html;
    }
    console.log("Files display completed");
  }

  // Delete file
  async function deleteFile(fileId) {
    if (!token) {
      showMessage('Please login first!', true);
      showSection('login-section');
      return;
    }

    if (!confirm('Are you sure you want to delete this file?')) {
      return;
    }

    try {
      // Get CSRF token if not already present
      if (!csrfToken) {
        await getCsrfToken();
      }

      const response = await fetch(`http://localhost:8080/api/files/${fileId}`, {
        method: 'DELETE',
        headers: {
          'Authorization': `Bearer ${token}`,
          'X-XSRF-TOKEN': csrfToken
        },
        credentials: 'include'
      });

      const data = await handleResponse(response);

      if (data.success) {
        showMessage('File deleted successfully!');
        loadFiles();
      } else {
        throw new Error(data.error || 'Deletion failed');
      }
    } catch (error) {
      showMessage(error.message, true);
    }
  }

  // Logout
  function logout() {
    localStorage.removeItem('cdnToken');
    localStorage.removeItem('cdnUser');
    token = null;
    currentUser = null;
    csrfToken = '';
    showMessage('Logged out successfully!');
    initializeApp();
  }

  // Helper function to format file size
  function formatFileSize(bytes) {
    if (bytes < 1024) return bytes + ' bytes';
    else if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
    else if (bytes < 1073741824) return (bytes / 1048576).toFixed(1) + ' MB';
    else return (bytes / 1073741824).toFixed(1) + ' GB';
  }

  // Helper function to format date
  function formatDate(timestamp) {
    return new Date(timestamp).toLocaleString();
  }

  // Add system info loading function for admin panel
  async function loadSystemInfo() {
    const button = document.getElementById('system-info-button');
    button.disabled = true;
    button.classList.add('loading');
    
    try {
      const systemInfoDiv = document.getElementById('system-info');
      systemInfoDiv.innerHTML = '<p>Loading system information...</p>';
      
      const response = await fetch('http://localhost:8080/api/metrics/storage', {
        method: 'GET',
        headers: {
          'Authorization': `Bearer ${token}`
        }
      });
      
      const data = await handleResponse(response);
      
      if (data) {
        const totalSizeMB = (data.totalSize / (1024 * 1024)).toFixed(2);
        const diskTotalGB = (data.diskTotalSpace / (1024 * 1024 * 1024)).toFixed(2);
        const diskUsedGB = (data.diskUsedSpace / (1024 * 1024 * 1024)).toFixed(2);
        const diskFreeGB = (data.diskUsableSpace / (1024 * 1024 * 1024)).toFixed(2);
        
        systemInfoDiv.innerHTML = `
          <div class="info-card">
            <h4>Storage Information</h4>
            <p>Total Files: ${data.totalFiles}</p>
            <p>Total Size: ${totalSizeMB} MB</p>
            <p>Disk Space: ${diskUsedGB} GB used of ${diskTotalGB} GB (${diskFreeGB} GB free)</p>
            
            <h4>Files by Type</h4>
            <ul>
              ${Object.entries(data.filesByType || {}).map(([type, count]) => 
                `<li>${type}: ${count} files</li>`).join('')}
            </ul>
          </div>
        `;
      } else {
        systemInfoDiv.innerHTML = '<p>Error loading system information.</p>';
      }
    } catch (error) {
      showMessage(error.message, true);
      document.getElementById('system-info').innerHTML = '<p>Error loading system information.</p>';
    } finally {
      button.disabled = false;
      button.classList.remove('loading');
    }
  }

  // Load all users (admin only)
  async function loadUsers() {
    const button = document.getElementById('load-users-button');
    button.disabled = true;
    button.classList.add('loading');

    try {
      if (!token) {
        throw new Error('Please login first!');
      }

      const response = await fetch('http://localhost:8080/api/auth/users', {
        method: 'GET',
        headers: {
          'Authorization': `Bearer ${token}`
        }
      });

      // Log the raw response for debugging
      console.log("Raw response:", await response.clone().text());
      
      const data = await handleResponse(response);
      console.log("Parsed response data:", data);

      if (data.success) {
        // Handle different response structures
        let usersData = data.data;
        
        // If data.data is an object with a 'users' property, use that
        if (usersData && typeof usersData === 'object' && usersData.users) {
          usersData = usersData.users;
        }
        
        displayUsers(usersData);
      } else {
        throw new Error(data.error || 'Failed to load users');
      }
    } catch (error) {
      console.error("Error loading users:", error);
      showMessage(error.message, true);
    } finally {
      button.disabled = false;
      button.classList.remove('loading');
    }
  }

  // Display users list
  function displayUsers(usersData) {
    console.log("Raw users data:", usersData);
    const usersList = document.getElementById('users-list');

    // Convert users to array if it's not already
    let users = [];
    
    if (!usersData) {
      usersList.innerHTML = '<p>No users found.</p>';
      return;
    }
    
    // Handle different formats of user data
    if (Array.isArray(usersData)) {
      users = usersData;
    } else if (typeof usersData === 'object') {
      // If we received an object with a 'users' property
      if (usersData.users) {
        if (Array.isArray(usersData.users)) {
          users = usersData.users;
        } else if (typeof usersData.users === 'object') {
          // If users is an object with numeric keys, convert to array
          users = Object.values(usersData.users);
        }
      } else {
        // If just a simple object with numeric keys, convert to array
        users = Object.values(usersData);
      }
    }
    
    console.log("Processed users array:", users);
    
    if (users.length === 0) {
      usersList.innerHTML = '<p>No users found.</p>';
      return;
    }

    let html = '<div class="users-grid">';
    users.forEach(user => {
      if (!user) return; // Skip null/undefined users
      
      const lastLoginText = user.lastLogin ? formatDate(user.lastLogin) : 'Never';
      
      // Ensure roles is an array
      let roles = [];
      if (user.roles) {
        if (Array.isArray(user.roles)) {
          roles = user.roles;
        } else if (typeof user.roles === 'string') {
          roles = [user.roles];
        } else if (typeof user.roles === 'object') {
          roles = Object.values(user.roles);
        }
      }
      
      // Generate role badges
      const roleBadges = roles.map(role => {
        if (!role) return '';
        return `<span class="badge ${role.toLowerCase()}">${role}</span>`;
      }).join(' ');
      
      html += `
        <div class="user-card">
          <div class="user-header">
            <h3>${user.username}</h3>
            <div class="user-roles">
              ${roleBadges}
            </div>
          </div>
          <div class="user-details">
            <p><strong>Email:</strong> ${user.email}</p>
            <p><strong>User ID:</strong> ${user.id}</p>
            <p><strong>Status:</strong> ${user.active ? '<span class="active-badge">Active</span>' : '<span class="inactive-badge">Inactive</span>'}</p>
            <p><strong>Created:</strong> ${formatDate(user.createdAt)}</p>
            <p><strong>Last Login:</strong> ${lastLoginText}</p>
          </div>
          <div class="user-actions">
            <button onclick="viewUserFiles('${user.id}', '${user.username}')">View Uploads</button>
          </div>
        </div>
      `;
    });
    html += '</div>';
    usersList.innerHTML = html;
  }

  // View files uploaded by a specific user
  async function viewUserFiles(userId, username) {
    try {
      showMessage(`Loading files for user: ${username}...`);
      
      const response = await fetch(`http://localhost:8080/api/files/stats/${userId}`, {
        method: 'GET',
        headers: {
          'Authorization': `Bearer ${token}`
        }
      });

      const data = await handleResponse(response);
      
      if (data.success) {
        const stats = data.data;
        
        // Ensure files is an array
        let files = stats.files || [];
        if (!Array.isArray(files) && typeof files === 'object') {
          files = Object.values(files);
        }
        
        // Create modal to display user files
        const modal = document.createElement('div');
        modal.className = 'modal';
        
        // Use the passed username parameter instead of relying on the API response
        const displayName = username || `User ${userId.substr(0, 8)}`;
        
        let modalContent = `
          <div class="modal-content">
            <span class="close-button" onclick="this.parentElement.parentElement.remove();">&times;</span>
            <h2>Files uploaded by ${displayName}</h2>
            <div class="user-stats">
              <p>Total Files: <strong>${stats.totalFiles}</strong></p>
              <p>Total Size: <strong>${formatFileSize(stats.totalSize)}</strong></p>
              <p>Last Upload: <strong>${stats.lastUpload ? formatDate(stats.lastUpload) : 'Never'}</strong></p>
            </div>
        `;
        
        if (files.length === 0) {
          modalContent += '<p>This user has not uploaded any files yet.</p>';
        } else {
          modalContent += '<div class="files-grid">';
          files.forEach(file => {
            const isImage = file.contentType && file.contentType.startsWith('image/');
            modalContent += `
              <div class="file-item">
                ${isImage ? `<img src="http://localhost:8080/api/files/${file.id}/thumbnail/100" alt="${file.fileName}">` : ''}
                <div class="file-details">
                  <p><strong>${file.fileName}</strong></p>
                  <p>Type: ${file.contentType}</p>
                  <p>Size: ${formatFileSize(file.size)}</p>
                  <p>Uploaded: ${formatDate(file.uploadDate)}</p>
                </div>
                <div class="file-actions">
                  <button onclick="window.open('http://localhost:8080/api/files/${file.id}', '_blank')">View</button>
                </div>
              </div>
            `;
          });
          modalContent += '</div>';
        }
        
        modalContent += '</div>';
        modal.innerHTML = modalContent;
        
        document.body.appendChild(modal);
        
        // Add event to close modal when clicking outside
        modal.onclick = function(event) {
          if (event.target === modal) {
            modal.remove();
          }
        };
      } else {
        throw new Error(data.error || 'Failed to load user files');
      }
    } catch (error) {
      console.error("Error viewing user files:", error);
      showMessage(error.message, true);
    }
  }

  // Initialize the application
  initializeApp();
  getCsrfToken();
</script>
</body>
</html>